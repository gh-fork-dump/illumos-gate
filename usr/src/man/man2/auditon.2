.\"
.\" The contents of this file are subject to the terms of the
.\" Common Development and Distribution License (the "License").
.\" You may not use this file except in compliance with the License.
.\"
.\" You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
.\" or http://www.opensolaris.org/os/licensing.
.\" See the License for the specific language governing permissions
.\" and limitations under the License.
.\"
.\" When distributing Covered Code, include this CDDL HEADER in each
.\" file and include the License file at usr/src/OPENSOLARIS.LICENSE.
.\" If applicable, add the following below this CDDL HEADER, with the
.\" fields enclosed by brackets "[]" replaced with your own identifying
.\" information: Portions Copyright [yyyy] [name of copyright owner]
.\"
.\"
.\" Copyright (c) 2009, Sun Microsystems, Inc. All Rights Reserved
.\" Copyright (c) 2017 Peter Tribble
.\"
.Dd March 6, 2017
.Dt AUDITON 2
.Os
.Sh NAME
.Nm auditon
.Nd manipulate auditing
.Sh LIBRARY
.Lb libbsm
.Sh SYNOPSIS
.In sys/param.h
.In bsm/libbsm.h
.Ft int
.Fn auditon "int cmd" "caddr_t data" "int length"
.Sh DESCRIPTION
The
.Fn auditon
function performs various audit subsystem control operations.
The
.Fa cmd
argument designates the particular audit control command.
The
.Fa data
argument is a pointer to command-specific data.
The
.Fa length
argument is the length in bytes of the command-specific data.
.Pp
The following commands are supported:
.Bl -tag -width Ds
.It Dv A_GETCOND
Return the system audit condition in the integer pointed to by
.Fa data .
The following values can be returned:
.Pp
.Bl -tag -compact -width "AUC_INIT_AUDIT"
.It Dv AUC_AUDITING
Audit daemon is active.
.It Dv AUC_INIT_AUDIT
Audit is ready but auditd has not run.
.It Dv AUC_NOAUDIT
Audit daemon is not active.
.It Dv AUC_NOSPACE
Auditing has blocked due to lack of space in audit partition.
.El
.It Dv A_SETCOND
Set the system's audit on/off condition to the value in the integer pointed to
by
.Fa data .
The following audit states can be set:
.Pp
.Bl -tag -compact -width "AUC_INIT_AUDIT"
.It Dv AUC_AUDITING
Turns on audit record generation.
.It Dv AUC_NOAUDIT
Turns off audit record generation.
.El
.It Dv A_GETCLASS
Return the event to class mapping for the designated audit event.
The
.Fa data
argument points to the
.Vt au_evclass_map
structure containing the
event number.
The preselection class mask is returned in the same structure.
.It Dv A_SETCLASS
Set the event class preselection mask for the designated audit event.
The
.Fa data
argument points to the
.Vt au_evclass_map
structure containing the event number and class mask.
.It Dv A_GETKMASK
Return the kernel preselection mask in the
.Vt au_mask
structure pointed to by
.Fa data .
This is the mask used to preselect non-attributable audit events.
.It Dv A_SETKMASK
Set the kernel preselection mask.
The
.Fa data
argument points to the
.Vt au_mask
structure containing the class mask.
This is the mask used to preselect non-attributable audit events.
.It Dv A_GETPINFO
Return the audit ID, preselection mask, terminal ID and audit session ID of the
specified process in the
.Vt auditpinfo
structure pointed to by
.Vt data .
.Pp
Note that
.Dv A_GETPINFO
can fail if the terminal ID contains a network address longer than 32 bits.
In this case, the
.Dv A_GETPINFO_ADDR
command should be used.
.It Dv A_GETPINFO_ADDR
Returns the audit ID, preselection mask, terminal ID and audit session ID of
the specified process in the
.Vt auditpinfo_addr
structure pointed to by
.Fa data .
.It Dv A_SETPMASK
Set the preselection mask of the specified process.
The
.Fa data
argument points to the
.Vt auditpinfo
structure containing the process ID and the preselection mask.
The other fields of the structure are ignored and should be set to
.Dv NULL .
.It Dv A_SETUMASK
Set the preselection mask for all processes with the specified audit ID.
The
.Fa data
argument points to the
.Vt auditinfo
structure containing the audit ID and the preselection mask.
The other fields of the structure are ignored and should be set to
.Dv NULL .
.It Dv A_SETSMASK
Set the preselection mask for all processes with the specified audit session
ID.
The
.Fa data
argument points to the
.Vt auditinfo
structure containing the audit session ID and the preselection mask.
The other fields of the structure are ignored and should be set to
.Dv NULL .
.It Dv A_GETQCTRL
Return the kernel audit queue control parameters.
These control the high and
low water marks of the number of audit records allowed in the audit queue.
The high water mark is the maximum allowed number of undelivered audit records.
The low water mark determines when threads blocked on the queue are wakened.
Another parameter controls the size of the data buffer used to write data to
the audit trail.
There is also a parameter that specifies a maximum delay
before data is attempted to be written to the audit trail.
The audit queue parameters are returned in the
.Vt au_qctrl
structure pointed to by data.
.It Dv A_SETQCTRL
Set the kernel audit queue control parameters as described above in the
.Dv A_GETQCTRL
command.
The
.Fa data
argument points to the
.Vt au_qctrl
structure containing the audit queue control parameters.
The default and maximum values for the audit queue control parameters are:
.Bl -column "Control Parameter " "Default" "Maximum"
.It Sy Control Parameter Ta Sy Default Ta Sy Maximum Ta Sy Unit
.It high water           Ta 100        Ta 10000      Ta audit records
.It low water            Ta 10         Ta 1024       Ta audit records
.It output buffer size   Ta 1024       Ta 1048576    Ta bytes
.It delay                Ta 20         Ta 20000      Ta hundredths of a second
.El
.It Dv A_GETCWD
Return the current working directory as kept by the audit subsystem.
This is a path anchored on the real root, rather than on the active root.
The
.Fa data
argument points to a buffer into which the path is copied.
The
.Fa length
argument is the length of the buffer.
.It Dv A_GETCAR
Return the current active root as kept by the audit subsystem.
This path can be used to anchor an absolute path for a path token generated by
an application.
The
.Fa data
argument points to a buffer into which the path is copied.
The
.Fa length
argument is the length of the buffer.
.It Dv A_GETSTAT
Return the system audit statistics in the
.Vt audit_stat
structure pointed to by
.Fa data .
.It Dv A_SETSTAT
Reset system audit statistics values.
The kernel statistics value is reset if the corresponding field in the
statistics structure pointed to by the
.Fa data
argument is
.Dv CLEAR_VAL .
Otherwise, the value is not changed.
.It Dv A_GETPOLICY
Return the audit policy flags in the integer pointed to by
.Fa data .
.It Dv A_SETPOLICY
Set the audit policy flags to the values in the integer pointed to by
.Fa data .
The following policy flags are recognized:
.Bl -tag -width Ds
.It Dv AUDIT_CNT
Do not suspend processes when audit storage is full or inaccessible.
The default action is to suspend processes until storage becomes available.
.It Dv AUDIT_AHLT
Halt the machine when a non-attributable audit record can not be delivered.
The default action is to count the number of events that could not be recorded.
.It Dv AUDIT_ARGV
Include in the audit record the argument list for a member of the
.Xr exec 2
family of functions.
The default action is not to include this information.
.It Dv AUDIT_ARGE
Include the environment variables for the
.Fn execv
function in the audit record.
The default action is not to include this information.
.It Dv AUDIT_SEQ
Add a sequence token to each audit record.
The default action is not to include it.
.It Dv AUDIT_TRAIL
Append a trailer token to each audit record.
The default action is not to include it.
.It Dv AUDIT_GROUP
Include the supplementary groups list in audit records.
The default action is not to include it.
.It Dv AUDIT_PATH
Include secondary paths in audit records.
Examples of secondary paths are dynamically loaded shared library modules and
the command shell path for executable scripts.
The default action is to include only the primary path from the system call.
.It Dv AUDIT_WINDATA_DOWN
Include in an audit record any downgraded data moved between windows.
This policy is available only if the system is configured with Trusted
Extensions.
By default, this information is not included.
.It Dv AUDIT_WINDATA_UP
Include in an audit record any upgraded data moved between windows.
This policy is available only if the system is configured with Trusted
Extensions.
By default, this information is not included.
.It Dv AUDIT_PERZONE
Enable auditing for each local zone.
If not set, audit records from all zones are collected in a single log
accessible in the global zone and certain
.Xr auditconfig 1M
operations are disallowed.
This policy can be set only from the global zone.
.It Dv AUDIT_ZONENAME
Generate a zone ID token with each audit record.
.El
.El
.Sh RETURN VALUES
.Rv -std
.Sh ERRORS
The
.Fn auditon
function will fail if:
.Bl -tag -width Er
.It Bq Er E2BIG
The
.Fa length
field for the command was too small to hold the returned value.
.It Bq Er EFAULT
The copy of
.Fa data
to/from the kernel failed.
.It Bq Er EINVAL
One of the arguments was illegal, Audit has not been installed, or the
operation is not valid from a local zone.
.It Bq Er EPERM
The
.Brq Dv PRIV_SYS_AUDIT
privilege is not asserted in the effective set of the calling process.
.Pp
Neither the
.Brq Dv PRIV_PROC_AUDIT
nor the
.Brq Dv PRIV_SYS_AUDIT
privilege is asserted in the effective set of the calling process and the
command is one of
.Dv A_GETCAR , A_GETCLASS , A_GETCOND , A_GETCWD , A_GETPINFO , A_GETPOLICY .
.El
.Sh USAGE
The
.Fn auditon
function can be invoked only by processes with appropriate privileges.
.Pp
The use of
.Fn auditon
to change system audit state is permitted only in the global zone.
From any other zone
.Fn auditon
returns -1 with errno set to
.Er EPERM .
The following
.Fn auditon
commands are permitted only in the global zone:
.Dv A_SETCOND , A_SETCLASS , A_SETKMASK, A_SETQCTRL, A_SETSTAT, A_SETFSIZE
and
.Dv A_SETPOLICY .
All other
.Fn auditon
commands are valid from any zone.
.Sh INTERFACE STABILITY
.Sy Committed
.Sh MT-LEVEL
.Sy MT-Safe
.Sh SEE ALSO
.Xr auditconfig 1M ,
.Xr auditd 1M ,
.Xr audit 2 ,
.Xr exec 2 ,
.Xr audit.log 4 ,
.Xr attributes 5 ,
.Xr privileges 5
.Sh NOTES
The auditon options that modify or display process-based information are not
affected by the "perzone" audit policy.
Those that modify system audit data such as the terminal ID and audit queue
parameters are valid only in the global zone unless the "perzone" policy is
set.
The "get" options for system audit data reflect the local zone if "perzone" is
set; otherwise they reflects the settings of the global zone.
