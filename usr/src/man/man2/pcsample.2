.\"
.\" The contents of this file are subject to the terms of the
.\" Common Development and Distribution License (the "License").
.\" You may not use this file except in compliance with the License.
.\"
.\" You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
.\" or http://www.opensolaris.org/os/licensing.
.\" See the License for the specific language governing permissions
.\" and limitations under the License.
.\"
.\" When distributing Covered Code, include this CDDL HEADER in each
.\" file and include the License file at usr/src/OPENSOLARIS.LICENSE.
.\" If applicable, add the following below this CDDL HEADER, with the
.\" fields enclosed by brackets "[]" replaced with your own identifying
.\" information: Portions Copyright [yyyy] [name of copyright owner]
.\"
.\"
.\" Copyright (c) 1998, Sun Microsystems, Inc. All Rights Reserved
.\"
.Dd March 10, 1998
.Dt PCSAMPLE 2
.Os
.Sh NAME
.Nm pcsample
.Nd program execution time profile
.Sh SYNOPSIS
.In pcsample.h
.Ft long
.Fn pcsample "uintptr_t samples[]" "long nsamples"
.Sh DESCRIPTION
The
.Fn pcsample
function provides CPU-use statistics by profiling the amount of CPU time
expended by a program.
.Pp
It is superior to
.Xr profil 2
when profiling dynamically-linked and/or 64-bit programs,
which assumes that the entire program is contained in a small,
contiguous segment of the address space, divides this segment into "bins", and
on each clock tick increments the counter in the bin where the program is
currently executing.
With shared libraries creating discontinuous program segments spread throughout
the address space, and with 64-bit address spaces so large that the size of
"bins" would be measured in megabytes, the
.Fn profil
function is of limited value.
.Pp
The
.Fn pcsample
function is passed an array
.Fa samples
containing
.Fa nsamples
pointer-sized elements.
During program execution, the kernel
samples the program counter of the process, storing unadulterated values in the
array on each clock tick.
The kernel stops writing to the array when it is
full, which occurs after
.Ql Va nsamples / Dv HZ
seconds of process virtual time.
The
.Dv HZ
value is obtained by invoking the call
.Fn sysconf "_SC_CLK_TCK" .
See
.Xr sysconf 3C .
.Pp
The sampling can be stopped by a subsequent call to
.Fn pcsample
with the
.Fa nsamples
argument set to 0.
Like
.Fn profil ,
sampling continues across a call to
.Xr fork 2 ,
but is disabled by a call to one of the
.Xr exec 2  family of functions.
It is also disabled if an
update of the
.Fa samples
array causes a memory fault.
.Sh RETURN VALUES
The
.Fn pcsample
function always returns 0 the first time it is
called.
On subsequent calls, it returns the number of samples that were stored
during the previous invocation.
If
.Fa nsamples
is invalid, -1 is returned and the global variable
.Va errno
is set to indicate the error.
.Sh ERRORS
The
.Fn pcsample
function will fail if:
.Bl -tag -width Er
.It Bq Er EINVAL
The value of
.Fa nsamples
is not valid.
.El
.Sh INTERFACE STABILITY
.Sy Stable
.Sh MT-LEVEL
.Sy Async-Signal-Safe
.Sh SEE ALSO
.Xr exec 2 ,
.Xr fork 2 ,
.Xr profil 2 ,
.Xr sysconf 3C ,
.Xr attributes 5
